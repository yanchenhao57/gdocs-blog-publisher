<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <title>Google Docs è½¬æ¢ä¸å‘å¸ƒå·¥å…·</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .step {
        margin-bottom: 20px;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 4px;
        opacity: 0.5;
        pointer-events: none;
      }
      .step.active {
        opacity: 1;
        pointer-events: auto;
        border-color: #4caf50;
        background: #f9f9f9;
      }
      .step-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }
      .step-number {
        width: 30px;
        height: 30px;
        background: #4caf50;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-weight: bold;
      }
      .step-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }
      .input-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }
      input[type="text"],
      textarea,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        margin-bottom: 10px;
      }
      button {
        background: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }
      #richtext-preview {
        background: #f8f8f8;
        padding: 15px;
        border-radius: 4px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 400px;
        overflow: auto;
      }
      #log-output {
        background: #2b2b2b;
        color: #fff;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        max-height: 200px;
        overflow: auto;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid #444;
      }
      .success {
        color: #4caf50;
      }
      .error {
        color: #f44336;
      }
      .info {
        color: #2196f3;
      }
      .preview-field {
        background: #f5f5f5;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      .preview-field span {
        color: #666;
        font-size: 0.9em;
      }

      /* æˆåŠŸçŠ¶æ€æ ·å¼ */
      .success-info {
        background: #f0f9f0;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
      }
      .link-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
      }
      .link-group a {
        color: #4caf50;
        text-decoration: none;
        word-break: break-all;
      }
      .link-group a:hover {
        text-decoration: underline;
      }
      .small-btn {
        padding: 5px 10px;
        font-size: 14px;
        white-space: nowrap;
      }

      /* AIç”Ÿæˆæ ‡è¯†æ ·å¼ */
      .ai-label {
        color: #007bff;
        font-size: 12px;
        font-weight: normal;
        margin-left: 5px;
      }
      .primary-btn {
        background: #2196f3;
        width: 100%;
        margin-top: 20px;
      }
      .primary-btn:hover {
        background: #1976d2;
      }
      #step4 .step-number {
        background: #4caf50;
        font-size: 16px;
      }
      .copy-success {
        animation: fadeOut 2s forwards;
      }
      @keyframes fadeOut {
        0% {
          opacity: 1;
        }
        70% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /* æ·»åŠ å¹³æ»‘æ»šåŠ¨æ•ˆæœ */
      html {
        scroll-behavior: smooth;
      }

      /* ç¡®ä¿æ¯ä¸ªæ­¥éª¤æœ‰è¶³å¤Ÿçš„ä¸Šä¸‹è¾¹è· */
      .step {
        margin: 30px 0;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 4px;
        opacity: 0.5;
        pointer-events: none;
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Google Docs è½¬æ¢ä¸å‘å¸ƒå·¥å…·</h1>

      <!-- æ­¥éª¤1ï¼šè¾“å…¥æ–‡æ¡£é“¾æ¥ -->
      <div class="step active" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <div class="step-title">è¾“å…¥ Google Docs æ–‡æ¡£é“¾æ¥</div>
        </div>
        <div class="input-group">
          <input
            type="text"
            id="doc-id"
            placeholder="ä¾‹å¦‚ï¼šhttps://docs.google.com/document/d/1HBWkPDoWzQdQ7wU7hooLGgoVK5SEYWl5xvX_3s_2RzM/edit"
            onpaste="handleDocLinkPaste(event)"
          />
          <button id="convert-btn" onclick="handleConvert()">æ‹‰å–å¹¶è½¬æ¢</button>
        </div>
      </div>

      <!-- æ­¥éª¤2ï¼šç¡®è®¤æ–‡ç« ä¿¡æ¯ -->
      <div class="step" id="step2">
        <div class="step-header">
          <div class="step-number">2</div>
          <div class="step-title">ç¡®è®¤æ–‡ç« ä¿¡æ¯</div>
        </div>
        <div class="input-group">
          <label for="blog-language">åšå®¢è¯­è¨€ï¼š</label>
          <select id="blog-language" onchange="handleLanguageChange()">
            <option value="en">English</option>
            <option value="jp">æ—¥æœ¬èª</option>
          </select>
        </div>
        <div class="input-group">
          <label for="seo-title"
            >SEO æ ‡é¢˜ï¼š<span class="ai-label">(AIç”Ÿæˆ)</span></label
          >
          <input type="text" id="seo-title" />
        </div>
        <div class="input-group">
          <label for="seo-description"
            >SEO æè¿°ï¼š<span class="ai-label">(AIç”Ÿæˆ)</span></label
          >
          <textarea id="seo-description" rows="2"></textarea>
        </div>
        <!-- æ–°å¢ï¼šæ ‡é¢˜é€‰æ‹©radioç»„ -->
        <div class="input-group">
          <label>é€‰æ‹©æ–‡ç« æ ‡é¢˜ï¼š</label>
          <div id="title-options">
            <label>
              <input type="radio" name="title-source" value="ai" checked />
              <span id="radio-ai-title">AI ç”Ÿæˆæ ‡é¢˜</span>
            </label>
            <label>
              <input type="radio" name="title-source" value="h1" />
              <span id="radio-h1-title">ç¬¬ä¸€ä¸ª H1</span>
            </label>
            <label>
              <input type="radio" name="title-source" value="custom" />
              <span>è‡ªå®šä¹‰</span>
            </label>
          </div>
        </div>
        <div class="input-group">
          <label for="heading-h1">æ–‡ç« æ ‡é¢˜ï¼š</label>
          <input type="text" id="heading-h1" />
        </div>
        <div class="input-group">
          <label for="slug">Slugï¼š<span class="ai-label">(AIç”Ÿæˆ)</span></label>
          <input
            type="text"
            id="slug"
            onchange="updateCanonical()"
            oninput="updateCanonical()"
          />
        </div>

        <div class="input-group">
          <label for="reading-time"
            >é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ï¼š<span class="ai-label">(AIç”Ÿæˆ)</span></label
          >
          <input type="number" id="reading-time" min="1" />
        </div>
        <div class="input-group">
          <label for="cover-url">å°é¢å›¾é“¾æ¥ï¼š</label>
          <input type="text" id="cover-url" />
          <a
            href="https://notta-manager.notta.io/tools/assetsManage/"
            target="_blank"
            class="button"
            style="
              margin-left: 10px;
              text-decoration: none;
              padding: 4px 8px;
              border: 1px solid #ccc;
              border-radius: 4px;
            "
          >
            ä¸Šä¼ å°é¢å›¾
          </a>
          <!-- æ–°å¢ï¼šå°é¢å›¾é¢„è§ˆ -->
          <img
            id="cover-preview"
            src=""
            alt="å°é¢å›¾é¢„è§ˆ"
            style="max-width: 500px; display: block; margin-top: 8px"
          />
        </div>
        <div class="input-group">
          <label for="cover-alt"
            >å°é¢å›¾ Alt Textï¼š<span class="ai-label">(AIç”Ÿæˆ)</span></label
          >
          <input type="text" id="cover-alt" placeholder="å›¾ç‰‡çš„æ›¿ä»£æ–‡æœ¬æè¿°" />
        </div>
        <div class="input-group">
          <label for="author">ä½œè€…ï¼š</label>
          <select id="author"></select>
        </div>
        <div class="input-group">
          <label>Canonical é“¾æ¥é¢„è§ˆï¼š</label>
          <div class="preview-field" id="canonical-preview">
            <span>ç­‰å¾…ç”Ÿæˆ...</span>
          </div>
          <input type="hidden" id="canonical" />
        </div>

        <!-- AIå†…å®¹é‡æ–°ç”ŸæˆæŒ‰é’® -->
        <div
          class="input-group"
          style="
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
          "
        >
          <label style="font-size: 16px; color: #495057; margin-bottom: 15px"
            >AIå†…å®¹é‡æ–°ç”Ÿæˆ</label
          >
          <p style="color: #6c757d; margin-bottom: 15px; font-size: 14px">
            å¦‚æœå¯¹AIç”Ÿæˆçš„å†…å®¹ä¸æ»¡æ„ï¼Œå¯ä»¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡æ–°ç”Ÿæˆæ‰€æœ‰AIå†…å®¹
          </p>
          <button
            onclick="regenerateAiContent()"
            id="regenerate-btn"
            style="
              background: #007bff;
              color: white;
              padding: 12px 24px;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 500;
            "
          >
            ğŸ”„ é‡æ–°ç”ŸæˆAIå†…å®¹
          </button>
        </div>

        <button onclick="goToStep(3)">ä¸‹ä¸€æ­¥</button>
      </div>

      <!-- æ­¥éª¤3ï¼šé¢„è§ˆå’Œä¿å­˜è‰ç¨¿ -->
      <div class="step" id="step3">
        <div class="step-header">
          <div class="step-number">3</div>
          <div class="step-title">é¢„è§ˆå’Œä¿å­˜è‰ç¨¿</div>
        </div>
        <div class="preview-section">
          <h3>æ–‡ç« é¢„è§ˆ</h3>
          <div class="preview-field">
            <label>SEO æ ‡é¢˜ï¼š</label>
            <span id="preview-seo-title"></span>
          </div>
          <div class="preview-field">
            <label>SEO æè¿°ï¼š</label>
            <span id="preview-seo-description"></span>
          </div>
          <div class="preview-field">
            <label>æ–‡ç« æ ‡é¢˜ï¼š</label>
            <span id="preview-heading-h1"></span>
          </div>
          <div class="preview-field">
            <label>Slugï¼š</label>
            <span id="preview-slug"></span>
          </div>

          <div class="preview-field">
            <label>é˜…è¯»æ—¶é—´ï¼š</label>
            <span id="preview-reading-time"></span>
          </div>
          <div class="preview-field">
            <label>Canonicalï¼š</label>
            <span id="preview-canonical"></span>
          </div>
          <h3>Richtext é¢„è§ˆ</h3>
          <pre id="richtext-preview">ç­‰å¾…è½¬æ¢...</pre>
        </div>
        <div class="button-group">
          <button onclick="goToStep(2)">ä¸Šä¸€æ­¥</button>
          <button id="publish-btn" onclick="handlePublish()" disabled>
            ä¿å­˜è‰ç¨¿
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤4ï¼šä¿å­˜æˆåŠŸ -->
      <div class="step" id="step4">
        <div class="step-header">
          <div class="step-number">âœ“</div>
          <div class="step-title">ä¿å­˜æˆåŠŸ</div>
        </div>
        <div class="success-info">
          <p style="margin-bottom: 15px; color: #666">
            æ–‡ç« å·²ä¿å­˜ä¸ºè‰ç¨¿ï¼Œè¯·åœ¨ Storyblok ä¸­å®¡æ ¸åå‘å¸ƒã€‚
          </p>
          <div class="preview-field">
            <label>é¢„è§ˆé“¾æ¥ï¼š</label>
            <div class="link-group">
              <a id="preview-link" href="#" target="_blank"></a>
              <button onclick="copyLink('preview-link')" class="small-btn">
                å¤åˆ¶é“¾æ¥
              </button>
            </div>
          </div>
          <div class="preview-field">
            <label>å‘å¸ƒåé“¾æ¥ï¼š</label>
            <div class="link-group">
              <a id="article-link" href="#" target="_blank"></a>
              <button onclick="copyLink('article-link')" class="small-btn">
                å¤åˆ¶é“¾æ¥
              </button>
            </div>
          </div>
          <div class="button-group">
            <button onclick="resetAndStartNew()" class="primary-btn">
              ç»§ç»­æ·»åŠ æ–°æ–‡ç« 
            </button>
          </div>
        </div>
      </div>

      <!-- æ—¥å¿—è¾“å‡º -->
      <div class="section">
        <h2>æ—¥å¿—è¾“å‡º</h2>
        <div id="log-output"></div>
      </div>
    </div>

    <script>
      // API é…ç½®
      const API_BASE = "http://localhost:3000/api";
      const NOTTA_BASE = "https://www.notta.ai";
      const JP_AUTHOR_MAP = {
        "satou-mitsuru": "ä½è—¤ã€€ãƒŸãƒ„ãƒ«",
        anna: "Anna",
        sann: "ã‚µãƒ³",
        aoi: "ã‚ãŠã„",
        "shi-esu": "ã—ãƒ¼ãˆã™",
        takowasa: "ãŸã“ã‚ã•",
        yamashita: "ãƒ¤ãƒã‚·ã‚¿",
        gon: "Gon",
        zero: "Zero",
        "sagou-masayuki": "ä½åˆå°†ä¹‹",
        matsui: "æ¾äº• æ¸…ï¼ˆã‚¹ãƒ©ãƒãƒ£ã‚¤ï¼‰",
        kanezaki: "é‡‘å´",
        tubasa: "tubasa",
        rina: "Rina",
        sai: "Sai",
        terawakikazuki: "å¯ºè„‡å’Œè¼",
        murada: "æ‘ç”°ãƒ¦ã‚¦ã‚¸",
        "notta-kun-1": "Nottaãã‚“",
      };
      const EN_AUTHOR_MAP = {
        "notta-team": "Notta Team",
        "viraj-mahajan": "Viraj Mahajan",
        "thomas-boldt": "Thomas Boldt",
        "ranee-zhang": "Ranee Zhang",
        "tobi-agbede": "Tobi Agbede",
        "joseph-buzhardt": "Joseph Buzhardt",
        "andre-walker": "Andre Walker",
        "rivi-richards": "Rivi Richards",
        "francesca-harrall": "Francesca Harrall",
        "andjela-vasic": "Andjela Vasic",
      };
      let currentRichtext = null;
      let currentStep = 1;
      let currentDocId = null; // å­˜å‚¨å½“å‰æ–‡æ¡£ID

      // æ–°å¢å…¨å±€å˜é‡
      let aiTitle = "";
      let h1Title = "";
      let currentMarkdown = ""; // å­˜å‚¨å½“å‰çš„markdownå†…å®¹

      // ä»é“¾æ¥ä¸­æå– Google Docs ID
      function extractDocId(link) {
        if (!link) return null;

        // å°è¯•åŒ¹é…ä¸åŒæ ¼å¼çš„Google Docsé“¾æ¥
        const patterns = [
          /\/document\/d\/([a-zA-Z0-9-_]+)/, // æ ‡å‡†æ ¼å¼
          /\/document\/u\/\d+\/d\/([a-zA-Z0-9-_]+)/, // å¸¦ç”¨æˆ·IDçš„æ ¼å¼
          /^([a-zA-Z0-9-_]+)$/, // ç›´æ¥è¾“å…¥IDçš„æ ¼å¼
        ];

        for (const pattern of patterns) {
          const match = link.match(pattern);
          if (match) {
            return match[1];
          }
        }

        return null;
      }

      // å¤„ç†é“¾æ¥ç²˜è´´
      function handleDocLinkPaste(event) {
        const input = event.target;

        // ä½¿ç”¨ setTimeout ç¡®ä¿åœ¨ç²˜è´´å®Œæˆåè·å–å€¼
        setTimeout(() => {
          const pastedText = input.value.trim();
          const docId = extractDocId(pastedText);

          if (docId) {
            currentDocId = docId; // ä¿å­˜æ–‡æ¡£ID
            // å¦‚æœæ˜¯ç›´æ¥ç²˜è´´çš„IDï¼Œè½¬æ¢ä¸ºå®Œæ•´é“¾æ¥æ ¼å¼
            if (pastedText === docId) {
              input.value = `https://docs.google.com/document/d/${docId}`;
            }
          }
        }, 0);
      }

      // æ›´æ–° Canonical é“¾æ¥
      function updateCanonical() {
        const language = document.getElementById("blog-language").value;
        const slug = document.getElementById("slug").value;
        if (slug) {
          const prefix = language === "en" ? "en/blog/" : "blog/";
          const canonical = `${NOTTA_BASE}/${prefix}${slug}`;
          document.getElementById("canonical-preview").innerHTML = canonical;
          document.getElementById("canonical").value = canonical;
        }
      }

      // æ›´æ–°ä½œè€…ä¸‹æ‹‰æ¡†é€‰é¡¹
      function updateAuthorOptions() {
        const language = document.getElementById("blog-language").value;
        const authorSelect = document.getElementById("author");
        const authorMap = language === "en" ? EN_AUTHOR_MAP : JP_AUTHOR_MAP;

        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        authorSelect.innerHTML = "";

        // æ·»åŠ æ–°é€‰é¡¹
        Object.entries(authorMap).forEach(([id, name]) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = name;
          authorSelect.appendChild(option);
        });

        // éšæœºé€‰æ‹©ä¸€ä¸ªä½œè€…
        const authorIds = Object.keys(authorMap);
        const randomAuthorId =
          authorIds[Math.floor(Math.random() * authorIds.length)];
        authorSelect.value = randomAuthorId;
      }

      // å¤„ç†è¯­è¨€å˜åŒ–
      function handleLanguageChange() {
        updateCanonical();
        updateAuthorOptions();
        console.log(
          "è¯­è¨€åˆ‡æ¢ä¸ºï¼š",
          document.getElementById("blog-language").value
        );
      }

      // æ›´æ–°é¢„è§ˆå†…å®¹
      function updatePreview() {
        document.getElementById("preview-seo-title").textContent =
          document.getElementById("seo-title").value;
        document.getElementById("preview-seo-description").textContent =
          document.getElementById("seo-description").value;
        document.getElementById("preview-heading-h1").textContent =
          document.getElementById("heading-h1").value;
        document.getElementById("preview-slug").textContent =
          document.getElementById("slug").value;
        document.getElementById("preview-reading-time").textContent =
          document.getElementById("reading-time").value + " åˆ†é’Ÿ";
        document.getElementById("preview-canonical").textContent =
          document.getElementById("canonical").value;
      }

      // åˆ‡æ¢æ­¥éª¤
      function goToStep(step) {
        if (step === 3) {
          updatePreview();
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        document.querySelectorAll(".step").forEach((el, index) => {
          el.classList.toggle("active", index + 1 === step);
        });
        currentStep = step;

        // è·å–ç›®æ ‡æ­¥éª¤å…ƒç´ 
        const targetStep = document.getElementById(`step${step}`);
        if (targetStep) {
          // è®¡ç®—æ»šåŠ¨ä½ç½®ï¼ˆè€ƒè™‘ä¸€äº›ä¸Šè¾¹è·ï¼‰
          const offset = 30;
          const targetPosition = targetStep.offsetTop - offset;

          // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
          window.scrollTo({
            top: targetPosition,
            behavior: "smooth",
          });
        }
      }

      // æ—¥å¿—è¾“å‡ºå‡½æ•°
      function log(message, type = "info") {
        const logOutput = document.getElementById("log-output");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logOutput.insertBefore(entry, logOutput.firstChild);
      }

      // å¤„ç†è½¬æ¢è¯·æ±‚
      async function handleConvert() {
        const input = document.getElementById("doc-id");
        const docId = currentDocId || extractDocId(input.value);

        if (!docId) {
          log("è¯·è¾“å…¥æœ‰æ•ˆçš„ Google Docs é“¾æ¥", "error");
          return;
        }

        const convertBtn = document.getElementById("convert-btn");

        try {
          convertBtn.disabled = true;
          log("å¼€å§‹è½¬æ¢...", "info");

          const response = await fetch(`${API_BASE}/convert`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ docId }),
          });

          if (!response.ok) throw new Error("è½¬æ¢è¯·æ±‚å¤±è´¥");

          const data = await response.json();

          // ä¿å­˜markdownå†…å®¹ç”¨äºé‡æ–°ç”Ÿæˆ
          currentMarkdown = data.markdown || "";

          // æ›´æ–°è¡¨å•å­—æ®µ
          document.getElementById("seo-title").value =
            data.aiMeta.seo_title || "";
          document.getElementById("seo-description").value =
            data.aiMeta.seo_description || "";
          // æ–°å¢ï¼šä¿å­˜AIå’ŒH1æ ‡é¢˜
          aiTitle = data.aiMeta.heading_h1 || "";
          h1Title = data.firstH1Title || "";
          // è®¾ç½®radioæ–‡æœ¬
          document.getElementById(
            "radio-ai-title"
          ).textContent = `AI ç”Ÿæˆæ ‡é¢˜ï¼š${aiTitle}`;
          document.getElementById(
            "radio-h1-title"
          ).textContent = `ç¬¬ä¸€ä¸ª H1ï¼š${h1Title}`;
          // é»˜è®¤é€‰ä¸­H1æ ‡é¢˜
          document.querySelector(
            'input[name="title-source"][value="h1"]'
          ).checked = true;
          document.getElementById("heading-h1").value = h1Title;
          document.getElementById("heading-h1").readOnly = true;
          // ç»‘å®šradioäº‹ä»¶
          document
            .querySelectorAll('input[name="title-source"]')
            .forEach((radio) => {
              radio.addEventListener("change", function () {
                if (this.value === "ai") {
                  document.getElementById("heading-h1").value = aiTitle;
                  document.getElementById("heading-h1").readOnly = true;
                } else if (this.value === "h1") {
                  document.getElementById("heading-h1").value = h1Title;
                  document.getElementById("heading-h1").readOnly = true;
                } else {
                  document.getElementById("heading-h1").readOnly = false;
                  document.getElementById("heading-h1").focus();
                }
              });
            });
          document.getElementById("slug").value = data.aiMeta.slug || "";
          document.getElementById("reading-time").value =
            data.aiMeta.reading_time || "";
          document.getElementById("cover-alt").value =
            data.aiMeta.cover_alt || "";
          // æ–°å¢ï¼šå°é¢å›¾é“¾æ¥å’Œé¢„è§ˆ
          document.getElementById("cover-url").value = data.coverImage || "";
          document.getElementById("cover-preview").src = data.coverImage || "";
          document
            .getElementById("cover-url")
            .addEventListener("input", function () {
              document.getElementById("cover-preview").src = this.value;
            });

          // è®¾ç½®è¯­è¨€å¹¶è§¦å‘æ›´æ–°
          const languageSelect = document.getElementById("blog-language");
          languageSelect.value = data.aiMeta.language || "en";
          handleLanguageChange();

          // æ›´æ–° Canonical
          updateCanonical();

          // æ›´æ–° richtext é¢„è§ˆ
          currentRichtext = data.richtext;
          document.getElementById("richtext-preview").textContent =
            JSON.stringify(data.richtext, null, 2);

          // å¯ç”¨å‘å¸ƒæŒ‰é’®
          document.getElementById("publish-btn").disabled = false;

          // è½¬åˆ°ç¬¬äºŒæ­¥ï¼ˆç­‰å¾…å½“å‰æ“ä½œå®Œæˆåå†æ»šåŠ¨ï¼‰
          setTimeout(() => {
            goToStep(2);
          }, 100);

          log("è½¬æ¢æˆåŠŸï¼", "success");
        } catch (error) {
          log(`è½¬æ¢å¤±è´¥: ${error.message}`, "error");
        } finally {
          convertBtn.disabled = false;
        }
      }

      // å¤„ç†å‘å¸ƒè¯·æ±‚
      async function handlePublish() {
        if (!currentRichtext) {
          log("è¯·å…ˆè½¬æ¢æ–‡æ¡£", "error");
          return;
        }

        const publishBtn = document.getElementById("publish-btn");

        try {
          publishBtn.disabled = true;
          log("æ­£åœ¨ä¿å­˜è‰ç¨¿...", "info");

          // è·å–å¹¶è½¬æ¢é˜…è¯»æ—¶é—´ä¸ºæ•°å­—
          const readingTime = parseInt(
            document.getElementById("reading-time").value,
            10
          );
          if (isNaN(readingTime) || readingTime <= 0) {
            throw new Error("é˜…è¯»æ—¶é—´å¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—");
          }

          const blogData = {
            seo_title: document.getElementById("seo-title").value,
            seo_description: document.getElementById("seo-description").value,
            heading_h1: document.getElementById("heading-h1").value,
            slug: document.getElementById("slug").value,
            description: document.getElementById("seo-description").value, // å…¼å®¹åç«¯
            title: document.getElementById("heading-h1").value, // å…¼å®¹åç«¯
            reading_time: readingTime,
            coverUrl: document.getElementById("cover-url").value,
            coverAlt: document.getElementById("cover-alt").value,
            canonical: document.getElementById("canonical").value,
            body: currentRichtext,
            date: new Date().toISOString().split("T")[0] + " 00:00",
            author_id: document.getElementById("author").value,
            language: document.getElementById("blog-language").value,
            is_show_newsletter_dialog: false,
          };

          // éªŒè¯å¿…å¡«å­—æ®µ
          if (!blogData.title || !blogData.slug || !blogData.description) {
            throw new Error("æ ‡é¢˜ã€Slugå’Œæè¿°ä¸ºå¿…å¡«å­—æ®µ");
          }

          const response = await fetch(`${API_BASE}/publish`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...blogData,
              coverAlt: document.getElementById("cover-alt").value, // æ·»åŠ  alt text
            }),
          });

          if (!response.ok) throw new Error("å‘å¸ƒè¯·æ±‚å¤±è´¥");

          const result = await response.json();

          // ç”Ÿæˆé¢„è§ˆå’Œæ­£å¼é“¾æ¥
          const language = document.getElementById("blog-language").value;
          const slug = document.getElementById("slug").value;
          const prefix = language === "en" ? "en/blog/" : "blog/";

          // è®¾ç½®æ­£å¼è®¿é—®é“¾æ¥
          const articleLink = `${NOTTA_BASE}/${prefix}${slug}`;

          // è®¾ç½® Storyblok é¢„è§ˆé“¾æ¥ï¼ˆä½¿ç”¨ Dashboard æ ¼å¼ï¼‰
          const previewLink = `https://app.storyblok.com/#/me/spaces/${result.spaceId}/stories/0/0/${result.storyId}`;

          document.getElementById("article-link").href = articleLink;
          document.getElementById("article-link").textContent = articleLink;
          document.getElementById("preview-link").href = previewLink;
          document.getElementById("preview-link").textContent =
            "åœ¨ Storyblok ä¸­å®¡æ ¸";

          // è½¬åˆ°æˆåŠŸæ­¥éª¤ï¼ˆç­‰å¾…é“¾æ¥è®¾ç½®å®Œæˆåå†æ»šåŠ¨ï¼‰
          setTimeout(() => {
            goToStep(4);
          }, 100);

          log(`è‰ç¨¿ä¿å­˜æˆåŠŸï¼è¯·åœ¨ Storyblok ä¸­å®¡æ ¸åå‘å¸ƒ`, "success");
        } catch (error) {
          log(`å‘å¸ƒå¤±è´¥: ${error.message}`, "error");
        } finally {
          publishBtn.disabled = false;
        }
      }

      // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
      async function copyLink(elementId) {
        const link = document.getElementById(elementId).href;
        try {
          await navigator.clipboard.writeText(link);
          const btn = event.target;
          const originalText = btn.textContent;
          btn.textContent = "å·²å¤åˆ¶ï¼";
          btn.classList.add("copy-success");
          setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove("copy-success");
          }, 2000);
        } catch (err) {
          log("å¤åˆ¶é“¾æ¥å¤±è´¥", "error");
        }
      }

      // å‘å¸ƒæˆåŠŸåçš„å¤„ç†
      function handlePublishSuccess(result) {
        // ç”Ÿæˆé¢„è§ˆå’Œæ­£å¼é“¾æ¥
        const language = document.getElementById("blog-language").value;
        const slug = document.getElementById("slug").value;
        const prefix = language === "en" ? "en/blog/" : "blog/";

        // è®¾ç½®æ­£å¼è®¿é—®é“¾æ¥
        const articleLink = `${NOTTA_BASE}/${prefix}${slug}`;

        // è®¾ç½® Storyblok é¢„è§ˆé“¾æ¥ï¼ˆä½¿ç”¨ Dashboard æ ¼å¼ï¼‰
        const previewLink = `https://app.storyblok.com/#/me/spaces/${result.spaceId}/stories/0/0/${result.storyId}`;

        document.getElementById("article-link").href = articleLink;
        document.getElementById("article-link").textContent = articleLink;
        document.getElementById("preview-link").href = previewLink;
        document.getElementById("preview-link").textContent =
          "åœ¨ Storyblok ä¸­æ‰“å¼€";

        // è½¬åˆ°æˆåŠŸæ­¥éª¤ï¼ˆç­‰å¾…é“¾æ¥è®¾ç½®å®Œæˆåå†æ»šåŠ¨ï¼‰
        setTimeout(() => {
          goToStep(4);
        }, 100);

        log(`å‘å¸ƒæˆåŠŸï¼æ–‡ç« é“¾æ¥: ${articleLink}`, "success");
      }

      // é‡æ–°ç”ŸæˆAIå†…å®¹
      async function regenerateAiContent() {
        if (!currentDocId || !currentMarkdown) {
          log("è¯·å…ˆè½¬æ¢æ–‡æ¡£åå†é‡æ–°ç”Ÿæˆ", "error");
          return;
        }

        const regenerateBtn = document.getElementById("regenerate-btn");

        try {
          regenerateBtn.disabled = true;
          regenerateBtn.textContent = "ğŸ”„ ç”Ÿæˆä¸­...";
          log("å¼€å§‹é‡æ–°ç”ŸæˆAIå†…å®¹...", "info");

          const response = await fetch(`${API_BASE}/convert/regenerate`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              docId: currentDocId,
              markdown: currentMarkdown,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "é‡æ–°ç”Ÿæˆè¯·æ±‚å¤±è´¥");
          }

          const data = await response.json();

          // æ›´æ–°AIç”Ÿæˆçš„å†…å®¹
          document.getElementById("seo-title").value =
            data.aiMeta.seo_title || "";
          document.getElementById("seo-description").value =
            data.aiMeta.seo_description || "";

          // æ›´æ–°AIæ ‡é¢˜
          aiTitle = data.aiMeta.heading_h1 || "";
          document.getElementById(
            "radio-ai-title"
          ).textContent = `AI ç”Ÿæˆæ ‡é¢˜ï¼š${aiTitle}`;

          // æ ¹æ®å½“å‰é€‰ä¸­çš„æ ‡é¢˜ç±»å‹æ›´æ–°æ ‡é¢˜å­—æ®µ
          const selectedTitleSource = document.querySelector(
            'input[name="title-source"]:checked'
          ).value;
          if (selectedTitleSource === "ai") {
            document.getElementById("heading-h1").value = aiTitle;
          } else if (selectedTitleSource === "h1") {
            document.getElementById("heading-h1").value = h1Title;
          }
          // å¦‚æœæ˜¯è‡ªå®šä¹‰ï¼Œä¿æŒç”¨æˆ·è¾“å…¥çš„å†…å®¹ä¸å˜

          document.getElementById("slug").value = data.aiMeta.slug || "";
          document.getElementById("reading-time").value =
            data.aiMeta.reading_time || "";
          document.getElementById("cover-alt").value =
            data.aiMeta.cover_alt || "";

          // æ›´æ–°Canonicalé“¾æ¥
          updateCanonical();

          log("AIå†…å®¹é‡æ–°ç”ŸæˆæˆåŠŸï¼", "success");
        } catch (error) {
          log(`é‡æ–°ç”Ÿæˆå¤±è´¥: ${error.message}`, "error");
        } finally {
          regenerateBtn.disabled = false;
          regenerateBtn.textContent = "ğŸ”„ é‡æ–°ç”ŸæˆAIå†…å®¹";
        }
      }

      // é‡ç½®å¹¶å¼€å§‹æ–°æ–‡ç« 
      function resetAndStartNew() {
        // æ¸…ç©ºæ‰€æœ‰è¾“å…¥
        document.getElementById("doc-id").value = "";
        currentDocId = null; // é‡ç½®å½“å‰æ–‡æ¡£ID
        currentMarkdown = ""; // é‡ç½®markdownå†…å®¹
        document.getElementById("seo-title").value = "";
        document.getElementById("seo-description").value = "";
        document.getElementById("heading-h1").value = "";
        document.getElementById("slug").value = "";
        document.getElementById("reading-time").value = "";
        document.getElementById("cover-url").value = "";
        document.getElementById("cover-alt").value = ""; // æ¸…ç©º alt text
        document.getElementById("canonical").value = "";
        document.getElementById("richtext-preview").textContent = "ç­‰å¾…è½¬æ¢...";
        document.getElementById("canonical-preview").innerHTML =
          "<span>ç­‰å¾…ç”Ÿæˆ...</span>";

        // é‡ç½®å‘å¸ƒæŒ‰é’®çŠ¶æ€
        document.getElementById("publish-btn").disabled = true;

        // è¿”å›ç¬¬ä¸€æ­¥ï¼ˆç­‰å¾…é‡ç½®å®Œæˆåå†æ»šåŠ¨ï¼‰
        setTimeout(() => {
          goToStep(1);
        }, 100);

        // æ·»åŠ æ—¥å¿—
        log("å·²é‡ç½®ï¼Œå¯ä»¥å¼€å§‹æ–°æ–‡ç« ", "info");
      }

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", () => {
        log("å·¥å…·å·²å°±ç»ª", "info");
        updateAuthorOptions();
      });
    </script>
  </body>
</html>
