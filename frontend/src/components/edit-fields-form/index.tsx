"use client";

import React, { useState, useEffect, useMemo } from "react";
import {
  useEditableFields,
  useHasUnsavedChanges,
  usePublishState,
  useCanPublish,
  useConversionStoreClient,
} from "../../stores/conversionStoreClient";
import Input from "../input";
import Tab, { TabItem } from "../tab";
import FormItem from "../form-item";
import styles from "./index.module.css";
import {
  Bot,
  FileText,
  Edit3,
  ArrowLeft,
  ArrowRight,
  Rss,
  Replace,
  SquarePen,
} from "lucide-react";
import Dropdown, { DropdownOption } from "../dropdown";
import NumberStepper from "../number-stepper";
import {
  NOTTA_HOST,
  JP_BLOG_PATH,
  EN_BLOG_PATH,
  JP_AUTHOR_MAP,
  EN_AUTHOR_MAP,
} from "../../constants";
import ImagePreview from "../image-preview";
import Button from "../button";
import BlogCard from "../blog-card";
import SeoMetaCardExample from "../seo-meta-card/SeoMetaCardExample";
import SeoMetaCard from "../seo-meta-card";
import HorizontalBlogCardExample from "../horizontal-blog-card/HorizontalBlogCardExample";
import PrePublishCheck from "../pre-publish-check";

export default function EditFieldsForm() {
  const editableFields = useEditableFields();
  const hasUnsavedChanges = useHasUnsavedChanges();
  const publishState = usePublishState();
  const canPublish = useCanPublish();
  const [previewMode, setPreviewMode] = useState<boolean>(false);
  const [storyStatus, setStoryStatus] = useState<"exit" | "not-exit">(
    "not-exit"
  );
  const [loadingStoryStatus, setLoadingStoryStatus] = useState<boolean>(false);
  const [slugConflict, setSlugConflict] = useState<{
    exists: boolean;
    fullSlug: string;
  } | null>(null);
  const [isCheckingUrl, setIsCheckingUrl] = useState(false);

  // Êú¨Âú∞Áä∂ÊÄÅÁÆ°ÁêÜ
  const [currentTabId, setCurrentTabId] = useState<string>("ai");
  const [customTitle, setCustomTitle] = useState<string>("");

  const {
    updateEditableField,
    publishToStoryblok,
    regenerateAiData,
    resetWorkflow,
    currentDocId,
    result,
  } = useConversionStoreClient();
  console.log("üöÄ ~ EditFieldsForm ~ result:", result);

  // ÂàùÂßãÂåñÊó∂ËÆæÁΩÆÈªòËÆ§ÁöÑÊ†áÈ¢òÊù•Ê∫ê
  useEffect(() => {
    if (result?.aiMeta?.heading_h1) {
      setCurrentTabId("ai");
      updateEditableField("heading_h1", result.aiMeta.heading_h1);
    } else if (result?.firstH1Title) {
      setCurrentTabId("document");
      updateEditableField("heading_h1", result.firstH1Title);
    }
  }, [result, updateEditableField]);

  // ÂçïÁã¨ÁöÑ useEffect Â§ÑÁêÜ‰ΩúËÄÖÂàùÂßãÂåñÂíåËØ≠Ë®ÄÂèòÂåñ
  useEffect(() => {
    const currentLanguage = editableFields.language || "en";

    // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆ‰ΩúËÄÖÔºåÊàñËÄÖÂΩìÂâç‰ΩúËÄÖ‰∏çÂú®Êñ∞ËØ≠Ë®ÄÁöÑ‰ΩúËÄÖÂàóË°®‰∏≠ÔºåÂàôÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™
    const authorMap = currentLanguage === "ja" ? JP_AUTHOR_MAP : EN_AUTHOR_MAP;
    const currentAuthorExists =
      editableFields.author_id &&
      (editableFields.author_id as keyof typeof authorMap) in authorMap;

    if (!editableFields.author_id || !currentAuthorExists) {
      const randomAuthor = getRandomAuthor(currentLanguage);
      updateEditableField("author_id", randomAuthor);
      console.log(
        "Set random author for",
        currentLanguage,
        ":",
        randomAuthor,
        "->",
        authorMap[randomAuthor as keyof typeof authorMap]
      );
    }
  }, [editableFields.language, editableFields.author_id, updateEditableField]);

  const titleTabItems: TabItem[] = [
    {
      id: "ai",
      label: "AI Generated",
      icon: <Bot size={16} />,
    },
    {
      id: "document",
      label: "Document First H1",
      icon: <FileText size={16} />,
    },
    {
      id: "custom",
      label: "Custom",
      icon: <Edit3 size={16} />,
    },
  ];

  // ËØ≠Ë®ÄÈÄâÈ°πÈÖçÁΩÆ
  const languageOptions: DropdownOption[] = [
    {
      id: "en",
      label: "English",
      icon: <span style={{ fontSize: "18px" }}>üá∫üá∏</span>,
    },
    {
      id: "ja",
      label: "Êó•Êú¨Ë™û",
      icon: <span style={{ fontSize: "18px" }}>üáØüáµ</span>,
    },
  ];

  // ÂàõÂª∫È¶ñÂ≠óÊØçÂõæÊ†áÁªÑ‰ª∂
  const createInitialIcon = (name: string) => {
    const initial = name.charAt(0).toUpperCase();
    return (
      <div
        style={{
          width: "18px",
          height: "18px",
          borderRadius: "50%",
          backgroundColor: "#3b82f6",
          color: "white",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "10px",
          fontWeight: "600",
        }}
      >
        {initial}
      </div>
    );
  };

  // Ê†πÊçÆËØ≠Ë®ÄËé∑Âèñ‰ΩúËÄÖÈÄâÈ°π
  const getAuthorOptions = (language: string): DropdownOption[] => {
    const authorMap = language === "ja" ? JP_AUTHOR_MAP : EN_AUTHOR_MAP;
    return Object.entries(authorMap).map(([id, name]) => ({
      id,
      label: name,
      icon: createInitialIcon(name),
    }));
  };

  // Ëé∑ÂèñÂΩìÂâçËØ≠Ë®ÄÁöÑ‰ΩúËÄÖÈÄâÈ°πÔºà‰ΩøÁî®useMemoÁ°Æ‰øùÂú®ËØ≠Ë®ÄÂèòÂåñÊó∂ÈáçÊñ∞ËÆ°ÁÆóÔºâ
  const authorOptions = useMemo(() => {
    return getAuthorOptions(editableFields.language || "en");
  }, [editableFields.language]);

  // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™‰ΩúËÄÖ
  const getRandomAuthor = (language: string) => {
    const authorMap = language === "ja" ? JP_AUTHOR_MAP : EN_AUTHOR_MAP;
    const authorIds = Object.keys(authorMap);
    const randomIndex = Math.floor(Math.random() * authorIds.length);
    return authorIds[randomIndex];
  };

  // Ëé∑ÂèñÈªòËÆ§‰ΩúËÄÖIDÔºåÂ¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÂàôÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™
  const getDefaultAuthorId = () => {
    if (editableFields.author_id) {
      return editableFields.author_id;
    }
    return getRandomAuthor(editableFields.language || "en");
  };

  const handleTitleTabChange = (tabId: string) => {
    // Â¶ÇÊûúÂΩìÂâçÊòØcustomÊ®°ÂºèÔºå‰øùÂ≠òÁî®Êà∑ËæìÂÖ•
    if (currentTabId === "custom") {
      setCustomTitle(editableFields.heading_h1);
    }

    setCurrentTabId(tabId);

    switch (tabId) {
      case "ai":
        updateEditableField("heading_h1", result?.aiMeta?.heading_h1 || "");
        break;
      case "document":
        updateEditableField("heading_h1", result?.firstH1Title || "");
        break;
      case "custom":
        // ÊÅ¢Â§ç‰πãÂâç‰øùÂ≠òÁöÑËá™ÂÆö‰πâÊ†áÈ¢ò
        updateEditableField("heading_h1", customTitle);
        break;
    }
  };

  const handleTitleInputChange = (value: string) => {
    updateEditableField("heading_h1", value);
    // Â¶ÇÊûúÂΩìÂâçÊòØcustomÊ®°ÂºèÔºåÂÆûÊó∂Êõ¥Êñ∞customTitle
    if (currentTabId === "custom") {
      setCustomTitle(value);
    }
  };

  const handleLanguageChange = (languageId: string, option: DropdownOption) => {
    // Êõ¥Êñ∞ËØ≠Ë®ÄÔºåuseEffect‰ºöËá™Âä®Â§ÑÁêÜ‰ΩúËÄÖÁöÑÊõ¥Êñ∞
    updateEditableField("language", languageId);
    console.log("Language changed to:", languageId, option.label);
  };

  const handleAuthorChange = (authorId: string, option: DropdownOption) => {
    updateEditableField("author_id", authorId);
    console.log("Author changed to:", authorId, option.label);
  };

  const handleSeoTitleInputChange = (value: string) => {
    updateEditableField("seo_title", value);
  };

  const handleSeoDescriptionInputChange = (value: string) => {
    updateEditableField("seo_description", value);
  };

  const handlePublish = async () => {
    if (!canPublish) return;

    try {
      // Ë∞ÉÁî®Zustand‰∏≠ÁöÑpublishToStoryblok action
      // Ëøô‰∏™action‰ºöÂ§ÑÁêÜÊâÄÊúâÁöÑAPIË∞ÉÁî®„ÄÅÁä∂ÊÄÅÊõ¥Êñ∞ÂíåÂ∑•‰ΩúÊµÅËΩ¨Êç¢
      await publishToStoryblok();
    } catch (error) {
      // ÈîôËØØÂ∑≤ÁªèÂú®publishToStoryblok action‰∏≠Â§ÑÁêÜ‰∫Ü
      console.error("Publication failed:", error);
    }
  };

  const handleStartOver = () => {
    if (previewMode) {
      setPreviewMode(false);
    } else {
      resetWorkflow();
    }
  };

  const handleRegenerateAi = async () => {
    if (!currentDocId || !result?.markdown) {
      console.warn("Cannot regenerate AI: missing docId or markdown");
      return;
    }

    try {
      // Ë∞ÉÁî®Zustand‰∏≠ÁöÑregenerateAiData action
      await regenerateAiData(
        currentDocId,
        result.markdown,
        editableFields.language
      );
    } catch (error) {
      // ÈîôËØØÂ∑≤ÁªèÂú®regenerateAiData action‰∏≠Â§ÑÁêÜ‰∫Ü
      console.error("AI regeneration failed:", error);
    }
  };

  const handleNextStep = () => {
    if (!previewMode) {
      setPreviewMode(true);
    } else {
      handlePublish();
    }
  };

  const handleReadingTimeChange = (value: number) => {
    updateEditableField("reading_time", value);
  };

  const handleArticleSlugChange = (value: string) => {
    updateEditableField("slug", value);
  };

  const handleCanonicalUrlChange = (value: string) => {
    updateEditableField("canonical", value);
  };

  // Â§ÑÁêÜ pre-publish Ê£ÄÊü•ÁªìÊûú
  const handlePrePublishCheckResult = (exists: boolean, fullSlug: string) => {
    setSlugConflict({ exists, fullSlug });
  };

  const handleCheckStatusChange = (isChecking: boolean) => {
    setIsCheckingUrl(isChecking);
  };

  // ËÆ°ÁÆóÈªòËÆ§Canonical URL
  const defaultCanonicalUrl = useMemo(() => {
    const blogPath =
      editableFields.language === "ja" ? JP_BLOG_PATH : EN_BLOG_PATH;
    const slug = editableFields.slug;
    if (slug) {
      const canonicalUrl = `${NOTTA_HOST}${blogPath}/${slug}`;
      updateEditableField("canonical", canonicalUrl);
      return canonicalUrl;
    } else {
      updateEditableField("canonical", "");
      return "";
    }
  }, [editableFields.language, editableFields.slug]);

  const handleCoverImageChange = (value: string) => {
    updateEditableField("coverUrl", value);
  };

  const handleCoverImageAltChange = (value: string) => {
    updateEditableField("coverAlt", value);
  };

  const handleBack = () => {
    if (previewMode) {
      setPreviewMode(false);
      setSlugConflict(null);
    } else {
      resetWorkflow();
    }
  };

  return (
    <div className={styles.wrapper}>
      <h1 className={styles.title}>
        Configuring{" "}
        <span style={{ fontWeight: "bold", color: "#007bff" }}>
          ‚Äπ {result?.firstH1Title} ‚Ä∫
        </span>{" "}
        content fields
      </h1>
      <div className={styles.content}>
        <div className={styles.form_container_wrapper}>
          {previewMode ? (
            <>
              {/* È¢ÑËßàÊ®°Âºè */}
              <div className={styles.preview_container}>
                <div className={styles.preview_card}>
                  <BlogCard
                    title={editableFields.heading_h1}
                    description={editableFields.seo_description}
                    author={
                      editableFields.language === "ja"
                        ? JP_AUTHOR_MAP[
                            editableFields.author_id as keyof typeof JP_AUTHOR_MAP
                          ]
                        : EN_AUTHOR_MAP[
                            editableFields.author_id as keyof typeof EN_AUTHOR_MAP
                          ]
                    }
                    readingTime={
                      editableFields.reading_time.toString() +
                      " " +
                      (editableFields.reading_time <= 1 ? "minute" : "minutes")
                    }
                    publishDate={new Date().toISOString().split("T")[0]}
                    coverImage={editableFields.coverUrl}
                    showExternalIcon={true}
                  />
                </div>
                {/* SEO meta */}
                <div className={styles.seo_meta_container}>
                  <SeoMetaCard
                    title={editableFields.seo_title}
                    description={editableFields.seo_description}
                    canonical={editableFields.canonical}
                    editable={false}
                  />
                </div>

                {/* Pre-publish Check */}
                <div className={styles.pre_publish_container}>
                  <PrePublishCheck
                    slug={editableFields.slug}
                    language={editableFields.language as "en" | "ja"}
                    onCheckResult={handlePrePublishCheckResult}
                    onCheckStatusChange={handleCheckStatusChange}
                    autoCheck={true}
                  />
                </div>
              </div>
            </>
          ) : (
            <>
              {/* ÁºñËæëÊ®°Âºè */}
              <div className={styles.form_container}>
                {/* ÊñáÁ´†Ê†áÈ¢ò */}
                <FormItem label="Article Title" required>
                  <Input
                    id="title"
                    value={editableFields.heading_h1}
                    onChange={handleTitleInputChange}
                    placeholder="Enter your article title"
                  />
                  <Tab
                    items={titleTabItems}
                    defaultActiveId={currentTabId}
                    onChange={handleTitleTabChange}
                    className={styles.article_title_tab}
                  />
                </FormItem>

                {/* ËØ≠Ë®ÄÈÄâÊã© */}
                <FormItem label="Language / Ë®ÄË™û" required>
                  <Dropdown
                    options={languageOptions}
                    value={editableFields.language}
                    defaultValue={result?.aiMeta?.language || "en"}
                    placeholder="Select language"
                    searchable={false}
                    onChange={handleLanguageChange}
                  />
                </FormItem>

                {/* SEO title */}
                <FormItem label="SEO Title" required>
                  <Input
                    id="seo-title"
                    value={editableFields.seo_title}
                    onChange={handleSeoTitleInputChange}
                    placeholder="Enter your SEO title"
                  />
                </FormItem>

                {/* SEO description */}
                <FormItem label="SEO Description" required>
                  <Input
                    id="seo-description"
                    value={editableFields.seo_description}
                    onChange={handleSeoDescriptionInputChange}
                    placeholder="Enter your SEO description"
                  />
                </FormItem>

                {/* ÊñáÁ´† Slug */}
                <FormItem label="Article Slug" required>
                  <Input
                    id="article-slug"
                    value={editableFields.slug}
                    onChange={handleArticleSlugChange}
                    placeholder="Enter your article slug"
                  />
                </FormItem>

                {/* Canonical URL */}
                <FormItem label="Canonical URL" required>
                  <Input
                    id="canonical-url"
                    value={editableFields.canonical || defaultCanonicalUrl}
                    onChange={handleCanonicalUrlChange}
                    placeholder="Will be auto-generated based on language and slug"
                  />
                </FormItem>

                {/* ÊñáÁ´†ÈòÖËØªÊó∂Èó¥ */}
                <FormItem label="Reading Time" required>
                  <div className={styles.reading_time_container}>
                    <NumberStepper
                      min={1}
                      value={editableFields.reading_time}
                      onChange={handleReadingTimeChange}
                    />
                    <span className={styles.reading_time_unit}>
                      {editableFields.reading_time <= 1 ? "minute" : "minutes"}
                    </span>
                  </div>
                </FormItem>

                {/* ÊñáÁ´†Â∞ÅÈù¢ */}
                <FormItem label="Article Cover" required>
                  <ImagePreview
                    fullWidth={true}
                    aspectRatio={16 / 9}
                    imageUrl={editableFields.coverUrl}
                    altText={editableFields.coverAlt}
                    onImageUrlChange={handleCoverImageChange}
                    onAltTextChange={handleCoverImageAltChange}
                  />
                </FormItem>

                {/* ÊñáÁ´†‰ΩúËÄÖ */}
                <FormItem label="Article Author" required>
                  <Dropdown
                    options={authorOptions}
                    value={editableFields.author_id}
                    defaultValue={getDefaultAuthorId()}
                    placeholder="Select author"
                    searchable={true}
                    onChange={handleAuthorChange}
                  />
                </FormItem>
              </div>
            </>
          )}
        </div>
        <div className={styles.actions_container}>
          <div className={styles.actions_content}>
            {/* ÂèëÂ∏É */}
            <div className={styles.actions_item}>
              <Button
                className={`${styles.actions_button}`}
                onClick={handleNextStep}
                disabled={
                  publishState.isPublishing || (previewMode && isCheckingUrl)
                }
              >
                <div className={styles.actions_button_container}>
                  {previewMode ? (
                    <>
                      {isCheckingUrl ? (
                        <>
                          <div className={styles.spinner}></div>
                          Checking...
                        </>
                      ) : slugConflict?.exists ? (
                        <>
                          <SquarePen size={16} /> Update Story
                        </>
                      ) : (
                        <>
                          <Rss size={16} /> Publish
                        </>
                      )}
                    </>
                  ) : (
                    <>
                      Next
                      <ArrowRight size={16} />
                    </>
                  )}
                </div>
              </Button>

              {/* URL ÂÜ≤Á™ÅË≠¶ÂëäÊèêÁ§∫ */}
              {previewMode && slugConflict?.exists && !isCheckingUrl && (
                <div className={styles.conflict_warning}>
                  <strong>Warning:</strong> This URL already exists in
                  Storyblok. Publishing will overwrite the existing content.
                </div>
              )}
            </div>
            {/* ÈáçÊñ∞ÁîüÊàêAI */}
            <div className={styles.actions_item}>
              <Button
                className={styles.actions_button}
                onClick={handleRegenerateAi}
                variant="secondary"
              >
                Regenerate AI
              </Button>
              <span className={styles.regenerate_ai_description}>
                If you are not satisfied with the AI generated content, you can
                regenerate it.{" "}
                <strong>
                  If language is not correct, please change the language first.
                </strong>
              </span>
            </div>
            {/* cancel ÂõûÂà∞‰∏ä‰∏ÄÊ≠• */}
            <div className={styles.actions_item}>
              <Button variant="outline" onClick={handleBack}>
                <div className={styles.actions_button_container}>
                  <ArrowLeft size={16} />
                  Back
                </div>
              </Button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
